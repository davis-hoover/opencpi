# vim: ts=2:sw=2:et
#
# GitLab's yaml reference:
#   https://docs.gitlab.com/ee/ci/yaml/README.html
#

# Define the stages of the pipeline.
stages:
  - prep
  - prereq
  - build
  - test

#------------------------------------------------------------------------------
# JOBS
#------------------------------------------------------------------------------

prep:centos6:
  stage: prep
  tags:
    - docker
    - centos6
    - opencpi
  image: centos:6
  script:
  - yum -y distro-sync
  - scripts/install-packages.sh

prep:centos7:
  stage: prep
  tags:
    - docker
    - centos7
    - opencpi
  image: centos:7
  script:
  - yum -y distro-sync
  - scripts/install-packages.sh

prereq:centos7:
  stage: prereq
  tags:
    - shell
    - centos7
    - opencpi
  cache:
    key: "$CI_PIPELINE_IID"
    policy: push
    paths:
      - exports/
      - prerequisites/
      - prerequisites-build/
  script:
    - ./scripts/install-prerequisites.sh

build:centos7:
  stage: build
  tags:
    - shell
    - centos7
    - opencpi
  cache:
    key: "$CI_PIPELINE_IID"
    paths:
      - build/
      - exports/
      - os/
      - prerequisites/
      - prerequisites-build/
      - projects/
  script:
    - ./scripts/build-opencpi.sh

test:centos7:
  stage: test
  tags:
    - shell
    - centos7
    - opencpi
  cache:
    key: "$CI_PIPELINE_IID"
    policy: pull
    paths:
      - build/
      - exports/
      - os/
      - prerequisites/
      - prerequisites-build/
      - projects/
  script:
    - ./scripts/test-opencpi.sh

