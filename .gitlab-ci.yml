# vim: ts=2:sw=2:et
#
# GitLab's yaml reference:
#   https://docs.gitlab.com/ee/ci/yaml/README.html
#

# Job's with tag:opencpi run on our servers, not the cloud

# Define the stages of the pipeline.
stages:
  - prereq
  - build
  - build-rcc
  - build-primitives
  - build-workers
  - build-platforms
  - build-assemblies
  - build-test
  - test
  - deploy

# Global before and after scripts to run after each job. Overwrite in a specific
# job to prevent these from occurring.
default:
  before_script:
    - for f in artifacts*.tar; do if [ -f "$f" ]; then tar -xf "$f";  fi ; done
    - sleep 5
    - echo $(date "+%Y-%m-%d %H:%M:%S") > timestamp.txt
    - cat timestamp.txt
    - ls -lh
  after_script:
    - find -not -type d -newerct "$(< timestamp.txt)" > artifacts-$CI_JOB_STAGE-$CI_JOB_ID.txt
    - tar -T artifacts-$CI_JOB_STAGE-$CI_JOB_ID.txt -cf artifacts-$CI_JOB_STAGE-$CI_JOB_ID.tar
    - ls -lh artifacts-$CI_JOB_STAGE-$CI_JOB_ID.tar
    - for f in artifacts*.tar; do if [ "$f" != artifacts-$CI_JOB_STAGE-$CI_JOB_ID.tar ]; then rm -rf "$f";  fi ; done
  timeout: 24h

# Includes yaml files in the '.gitlab-ci' directory.
# Folder structure for the directory is as follows:
# - .yml file for host platform (e.g., centos7.yml)
# - Host Platform (e.g., centos7)
#   - .yml files for target platform (e.g., xilinx13_4.yml, xsim.yml, zed.yml)
include:
  # .gitlab-ci
  - /.gitlab-ci/templates.yml
  - /.gitlab-ci/docs.yml
  - /.gitlab-ci/centos6.yml
  - /.gitlab-ci/centos7.yml

  # centos6
  - /.gitlab-ci/centos6/xsim.yml
  - /.gitlab-ci/centos6/isim.yml
  - /.gitlab-ci/centos6/zed.yml
  - /.gitlab-ci/centos6/xilinx13_3.yml
  - /.gitlab-ci/centos6/xilinx13_4.yml
  - /.gitlab-ci/centos6/matchstiq_z1.yml

  # centos7
  - /.gitlab-ci/centos7/xsim.yml
  - /.gitlab-ci/centos7/isim.yml
  - /.gitlab-ci/centos7/zed.yml
  - /.gitlab-ci/centos7/xilinx13_3.yml
  - /.gitlab-ci/centos7/xilinx13_4.yml
  - /.gitlab-ci/centos7/matchstiq_z1.yml

  # downstream projects
  - /.gitlab-ci/e3xx.yml

