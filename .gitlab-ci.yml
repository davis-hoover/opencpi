# vim: ts=2:sw=2:et
#
# GitLab's yaml reference:
#   https://docs.gitlab.com/ee/ci/yaml/README.html
#

# Define the stages of the pipeline.
stages:
  - prep
  #- prereq
  #- build
  #- test

# Define types of runners. If any job uses the 'tags' key, then these templates
# will have no effect. If multiple templates are merged, '<<:', then the last
# one referenced will win.
.runner_defs:
  .shell_runner: &shell_runner
    tags:
      - opencpi
      - linux
      - shell

#------------------------------------------------------------------------------
# JOBS
#------------------------------------------------------------------------------

prep:centos6:
  stage: prep
  tags:
    - docker
    - linux
    - opencpi
  image: centos:6
  script:
  - yum -y distro-sync
  - scripts/install-packages.sh

.prereq:centos7:
  <<: *shell_runner
  stage: prereq
  cache:
    key: "$CI_PIPELINE_IID"
    policy: push
    paths:
      - exports/
      - prerequisites/
      - prerequisites-build/
  script:
    - ./scripts/install-prerequisites.sh

.build:opencpi:
  <<: *shell_runner
  stage: build
  cache:
    key: "$CI_PIPELINE_IID"
    paths:
      - build/
      - exports/
      - os/
      - prerequisites/
      - prerequisites-build/
      - projects/
  script:
    - ./scripts/build-opencpi.sh

.test:opencpi:
  <<: *shell_runner
  stage: test
  cache:
    key: "$CI_PIPELINE_IID"
    policy: pull
    paths:
      - build/
      - exports/
      - os/
      - prerequisites/
      - prerequisites-build/
      - projects/
  script:
    - ./scripts/test-opencpi.sh

