#################
# Jobs - Prereq #
#################
.install-packages:
  stage: prereq
  script:
    - yum -y distro-sync
    - ./scripts/install-packages.sh

.install-prereqs:
  extends:
    - .standard-artifacts
  stage: prereq
  script:
    - ./scripts/install-prerequisites.sh $PLATFORM


################
# Jobs - Build #
################
.build-opencpi:
  extends:
    - .standard-artifacts
  stage: build
  script:
    - ./scripts/build-opencpi.sh $PLATFORM

.build-rcc:
  extends:
    - .build-opencpi
  stage: build-rcc


###########################
# Jobs - Build-Primitives #
###########################
.build-primitives:
  extends:
    - .standard-artifacts
  stage: build-primitives
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/core/hdl/primitives --hdl-platform $PLATFORM
    - ocpidev build -d projects/platform/hdl/primitives --hdl-platform $PLATFORM
    - ocpidev build -d projects/assets/hdl/primitives --hdl-platform $PLATFORM
    - ocpidev build -d projects/inactive/hdl/primitives --hdl-platform $PLATFORM


###########################
# Jobs - Build-Components #
###########################
.build-components-core:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/core/components --hdl-platform $PLATFORM

.build-components-assets:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/assets/components --hdl-platform $PLATFORM

.build-components-assets-base:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/assets/components/base_comps --hdl-platform $PLATFORM

.build-components-assets-comms:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/assets/components/comms_comps --hdl-platform $PLATFORM

.build-components-assets-dsp:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/assets/components/dsp_comps --hdl-platform $PLATFORM

.build-components-assets-misc:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/assets/components/misc_comps --hdl-platform $PLATFORM

.build-components-assets-util:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/assets/components/util_comps --hdl-platform $PLATFORM

.build-components-assets_ts:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/assets_ts/components --hdl-platform $PLATFORM

.build-components-inactive:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/inactive/components --hdl-platform $PLATFORM


########################
# Jobs - Build-Devices #
########################
.build-devices-core:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/core/hdl/devices --hdl-platform $PLATFORM

.build-devices-platform:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/platform/hdl/devices --hdl-platform $PLATFORM

.build-devices-assets:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/assets/hdl/devices --hdl-platform $PLATFORM

.build-devices-assets_ts:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/assets_ts/hdl/devices --hdl-platform $PLATFORM

.build-devices-inactive:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/inactive/hdl/devices --hdl-platform $PLATFORM


#########################
# Jobs - Build-Adapters #
#########################
.build-adapters-core:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/core/hdl/adapters --hdl-platform $PLATFORM

.build-adapters-assets:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/assets/hdl/adapters --hdl-platform $PLATFORM


######################
# Jobs - Build-Cards #
######################
.build-cards-core:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/core/hdl/cards --hdl-platform $PLATFORM

.build-cards-assets:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/assets/hdl/cards --hdl-platform $PLATFORM

.build-cards-inactive:
  extends:
    - .standard-artifacts
  stage: build-workers
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/inactive/hdl/cards --hdl-platform $PLATFORM


##########################
# Jobs - Build-Platforms #
##########################
.build-platforms:
  after_script:
    - find -not -type d -newerct "$(< timestamp.txt)" > artifacts-$CI_JOB_STAGE-$CI_JOB_ID.txt
    - tar -T artifacts-$CI_JOB_STAGE-$CI_JOB_ID.txt -cf artifacts-$CI_JOB_STAGE-$CI_JOB_ID.tar
    - ls -lh artifacts-$CI_JOB_STAGE-$CI_JOB_ID.tar
    - for f in artifacts-build-workers-*.tar; do tar --concatenate -f artifacts-$CI_JOB_STAGE-$CI_JOB_ID.tar $f; done;
    - ls -lh artifacts-$CI_JOB_STAGE-$CI_JOB_ID.tar
    - for f in artifacts*.tar; do if [ "$f" != artifacts-$CI_JOB_STAGE-$CI_JOB_ID.tar ]; then rm -rf "$f";  fi ; done

.build-platforms-core:
  extends:
    - .standard-artifacts
    - .build-platforms
  stage: build-platforms
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build hdl platforms -d projects/core --hdl-platform $PLATFORM

.build-platforms-platform:
  extends:
    - .standard-artifacts
    - .build-platforms
  stage: build-platforms
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build hdl platforms -d projects/platform --hdl-platform $PLATFORM

.build-platforms-assets:
  extends:
    - .standard-artifacts
    - .build-platforms
  stage: build-platforms
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build hdl platforms -d projects/assets --hdl-platform $PLATFORM

.build-platforms-inactive:
  extends:
    - .standard-artifacts
    - .build-platforms
  stage: build-platforms
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build hdl platforms -d projects/inactive --hdl-platform $PLATFORM


###########################
# Jobs - Build-Assemblies #
###########################
.build-assemblies-platform:
  extends:
    - .standard-artifacts
  stage: build-assemblies
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build -d projects/platform/hdl/assemblies --hdl-platform $PLATFORM

.build-assemblies-assets:
  extends:
    - .standard-artifacts
  stage: build-assemblies
  script:
    - source ./cdk/opencpi-setup.sh -e
    - make -C projects/platform/ exports
    - make -C projects/assets/ imports
    - ocpidev build -d projects/assets/hdl/assemblies --hdl-platform $PLATFORM

.build-assemblies-assets_ts:
  extends:
    - .standard-artifacts
  stage: build-assemblies
  script:
    - source ./cdk/opencpi-setup.sh -e
    - make -C projects/platform/ exports
    - make -C projects/assets_ts/ imports
    - ocpidev build -d projects/assets_ts/hdl/assemblies --hdl-platform $PLATFORM

.build-assemblies-inactive:
  extends:
    - .standard-artifacts
  stage: build-assemblies
  script:
    - source ./cdk/opencpi-setup.sh -e
    - make -C projects/platform/ exports
    - make -C projects/inactive/ imports
    - ocpidev build -d projects/inactive/hdl/assemblies --hdl-platform $PLATFORM


###############
# Jobs - Test #
###############
.test-opencpi:
  stage: test
  artifacts:
    paths: []
  script:
    - ./scripts/test-opencpi.sh --no-hdl

.test-core:
  stage: test
  artifacts:
    paths: []
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build test -d projects/core --$MODEL-platform $PLATFORM
    - >
      if [[ -z $IP ]]; then
        ocpidev run tests -d projects/core --only-platform $PLATFORM --mode prep_run_verify;
      fi

.test-assets-base:
  stage: test
  artifacts:
    paths: []
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build test -d projects/assets/components/base_comps --$MODEL-platform $PLATFORM
    - >
      if [[ -z $IP ]]; then
        ocpidev run tests -d projects/assets/components/base_comps --only-platform $PLATFORM --mode prep_run_verify;
      fi

.test-assets-comms:
  stage: test
  artifacts:
    paths: []
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build test -d projects/assets/components/comms_comps --$MODEL-platform $PLATFORM
    - >
      if [[ -z $IP ]]; then
        ocpidev run tests -d projects/assets/components/comms_comps --only-platform $PLATFORM --mode prep_run_verify;
      fi

.test-assets-dsp:
  stage: test
  artifacts:
    paths: []
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build test -d projects/assets/components/dsp_comps --$MODEL-platform $PLATFORM
    - >
      if [[ -z $IP ]]; then
        ocpidev run tests -d projects/assets/components/dsp_comps --only-platform $PLATFORM --mode prep_run_verify;
      fi

.test-assets-misc:
  stage: test
  artifacts:
    paths: []
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build test -d projects/assets/components/misc_comps --$MODEL-platform $PLATFORM
    - >
      if [[ -z $IP ]]; then
        ocpidev run tests -d projects/assets/components/misc_comps --only-platform $PLATFORM --mode prep_run_verify;
      fi

.test-assets-util:
  stage: test
  artifacts:
    paths: []
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build test -d projects/assets/components/util_comps --$MODEL-platform $PLATFORM
    - >
      if [[ -z $IP ]]; then
        ocpidev run tests -d projects/assets/components/util_comps --only-platform $PLATFORM --mode prep_run_verify;
      fi

.test-assets_ts:
  stage: test
  artifacts:
    paths: []
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build test -d projects/assets_ts --$MODEL-platform $PLATFORM
    - >
      if [[ -z $IP ]]; then
        ocpidev run tests -d projects/assets_ts --only-platform $PLATFORM --mode prep_run_verify;
      fi

.test-inactive:
  stage: test
  artifacts:
    paths: []
  script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpidev build test -d projects/inactive --$MODEL-platform $PLATFORM
    - >
      if [[ -z $IP ]]; then
        ocpidev run tests -d projects/inactive --only-platform $PLATFORM --mode prep_run_verify;
      fi


#############
# Platforms #
#############

.centos7:
  extends:
    - .rules-default
  tags:
    - opencpi
    - centos7
    - shell
  variables:
    PLATFORM: 'centos7'
    IMAGE: 'centos:7'

.centos6:
  extends:
    - .rules-default
  tags:
    - opencpi
    - centos6
    - shell
  variables:
    PLATFORM: 'centos6'
    IMAGE: 'centos:6'

.xsim:
  extends:
    - .vivado
  variables:
    PLATFORM: 'xsim'
    MODEL: 'hdl'
  rules:
    - if: '$CI_HDL_PLATFORM =~ /(^| )xsim|all( |$)/i && $CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_HDL_PLATFORM =~ /(^| )xsim|all( |$)/i && $CI_COMMIT_MESSAGE !~  /\[ *ci.*\]/i'
    - if: '$CI_COMMIT_MESSAGE =~ /\[ *ci *\S* +xsim|all( \S*)*\]/i && $CI_PIPELINE_SOURCE != "web"'
    - if: "$CI_MERGE_REQUEST_ID"
    - if: "$CI_COMMIT_BRANCH == 'master'"
    - if: "$CI_COMMIT_BRANCH == 'develop'"

.modelsim:
  variables:
    PLATFORM: 'modelsim'
    MODEL: 'hdl'
    OCPI_MODELSIM_DIR: '/opt/Mentor/modelsim_dlx'
    OCPI_MODELSIM_LICENSE_FILE: '2103@sembach.opencpi.net'
  rules:
    - if: '$CI_HDL_PLATFORM =~ /(^| )modelsim|all( |$)/i && $CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_HDL_PLATFORM =~ /(^| )modelsim|all( |$)/i && $CI_COMMIT_MESSAGE !~  /\[ *ci.*\]/i'
    - if: '$CI_COMMIT_MESSAGE =~ /\[ *ci *\S* +modelsim|all( \S*)*\]/i && $CI_PIPELINE_SOURCE != "web"'
    - if: "$CI_MERGE_REQUEST_ID"
    - if: "$CI_COMMIT_BRANCH == 'master'"
    - if: "$CI_COMMIT_BRANCH == 'develop'"

.isim:
  extends:
    - .vivado
  variables:
    PLATFORM: 'isim'
    MODEL: 'hdl'
  rules:
    - if: '$CI_HDL_PLATFORM =~ /(^| )isim|all( |$)/i && $CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_HDL_PLATFORM =~ /(^| )isim|all( |$)/i && $CI_COMMIT_MESSAGE !~  /\[ *ci.*\]/i'
    - if: '$CI_COMMIT_MESSAGE =~ /\[ *ci *\S* +isim|all( \S*)*\]/i && $CI_PIPELINE_SOURCE != "web"'
    - if: "$CI_MERGE_REQUEST_ID"
    - if: "$CI_COMMIT_BRANCH == 'master'"
    - if: "$CI_COMMIT_BRANCH == 'develop'"

.xilinx13_3:
  extends:
    - .vivado
    - .rules-default
  variables:
    PLATFORM: 'xilinx13_3'
    HW_PLATFORM: 'zed'
    SW_PLATFORM: 'xilinx13_3'
    IP: '10.0.0.103'
    PORT: '1000'
    MODEL: 'rcc'

.xilinx13_4:
  extends:
    - .vivado
    - .rules-default
  variables:
    PLATFORM: 'xilinx13_4'
    HW_PLATFORM: 'zed'
    SW_PLATFORM: 'xilinx13_4'
    IP: '10.0.0.103'
    PORT: '1000'
    MODEL: 'rcc'

.zed-xilinx13_3:
  extends:
    - .vivado
  variables:
    PLATFORM: 'zed'
    HW_PLATFORM: 'zed'
    SW_PLATFORM: 'xilinx13_3'
    IP: '10.0.0.103'
    PORT: '1000'
    MODEL: 'hdl'

.zed-xilinx13_4:
  extends:
    - .vivado
  variables:
    PLATFORM: 'zed'
    HW_PLATFORM: 'zed'
    SW_PLATFORM: 'xilinx13_4'
    IP: '10.0.0.103'
    PORT: '1000'
    MODEL: 'hdl'
  rules:
    - if: '$CI_HDL_PLATFORM =~ /(^| )zed|all( |$)/i && $CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_HDL_PLATFORM =~ /(^| )zed|all( |$)/i && $CI_COMMIT_MESSAGE !~  /\[ *ci.*\]/i'
    - if: '$CI_COMMIT_MESSAGE =~ /\[ *ci *\S* +zed|all( \S*)*\]/i && $CI_PIPELINE_SOURCE != "web"'
    - if: "$CI_MERGE_REQUEST_ID"
    - if: "$CI_COMMIT_BRANCH == 'master'"
    - if: "$CI_COMMIT_BRANCH == 'develop'"

.matchstiq_z1-xilinx13_3:
  extends:
    - .vivado
  variables:
    PLATFORM: 'matchstiq_z1'
    HW_PLATFORM: 'matchstiq_z1'
    SW_PLATFORM: 'xilinx13_3'
    IP: '10.0.0.53'
    PORT: '1000'
    MODEL: 'hdl'
  rules:
    - if: '$CI_HDL_PLATFORM =~ /(^| )matchstiq_z1|all( |$)/i && $CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_HDL_PLATFORM =~ /(^| )matchstiq_z1|all( |$)/i && $CI_COMMIT_MESSAGE !~  /\[ *ci.*\]/i'
    - if: '$CI_COMMIT_MESSAGE =~ /\[ *ci *\S* +matchstiq_z1|all( \S*)*\]/i && $CI_PIPELINE_SOURCE != "web"'
    - if: "$CI_MERGE_REQUEST_ID"
    - if: "$CI_COMMIT_BRANCH == 'master'"
    - if: "$CI_COMMIT_BRANCH == 'develop'"

.zed_ise-xilinx13_4:
  extends:
    - .vivado
  variables:
    PLATFORM: 'zed_ise'
    HW_PLATFORM: 'zed_ise'
    SW_PLATFORM: 'xilinx13_4'
    IP: '10.0.0.1003'
    PORT: '1000'
    MODEL: 'hdl'
    XILINXD_LICENSE_FILE: '2101@sembach.opencpi.net'
  rules:
    - if: '$CI_HDL_PLATFORM =~ /(^| )zed_ise|all( |$)/i && $CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_HDL_PLATFORM =~ /(^| )zed_ise|all( |$)/i && $CI_COMMIT_MESSAGE !~  /\[ *ci.*\]/i'
    - if: '$CI_COMMIT_MESSAGE =~ /\[ *ci *\S* +zed_ise|all( \S*)*\]/i && $CI_PIPELINE_SOURCE != "web"'

.e3xx:
  rules:
    - if: '$CI_HDL_PLATFORM =~ /(^| )e31x|all( |$)/i && $CI_PIPELINE_SOURCE == "web"'
    - if: '$CI_HDL_PLATFORM =~ /(^| )e31x|all( |$)/i && $CI_COMMIT_MESSAGE !~  /\[ *ci.*\]/i'
    - if: '$CI_COMMIT_MESSAGE =~ /\[ *ci *\S* +e31x|all( \S*)*\]/i && $CI_PIPELINE_SOURCE != "web"'
    - if: "$CI_MERGE_REQUEST_ID"
    - if: "$CI_COMMIT_BRANCH == 'master'"
    - if: "$CI_COMMIT_BRANCH == 'develop'"


########
# Misc #
########
.standard-artifacts:
  artifacts:
    when: on_success
    expire_in: '3d'
    paths:
      - artifacts-$CI_JOB_STAGE-$CI_JOB_ID.tar

.rules-default:
  rules:
    - when: on_success

.vivado:
  before_script:
    - export HOME=$CI_PROJECT_DIR
    - for f in artifacts*.tar; do if [ -f "$f" ]; then tar -xf "$f";  fi ; done
    - sleep 5
    - echo $(date "+%Y-%m-%d %H:%M:%S") > timestamp.txt
    - cat timestamp.txt
    - ls -lh

.docker:
  tags:
    - docker
  image: $IMAGE

.ocpiremote:
  before_script:
    - export HOME=$CI_PROJECT_DIR
    - for f in artifacts*.tar; do if [ -f "$f" ]; then tar -xf "$f";  fi ; done
    - rm -f artifacts*.tar
    - sleep 5
    - echo $(date "+%Y-%m-%d %H:%M:%S") > timestamp.txt
    - cat timestamp.txt
    - ls -lh
    - source ./cdk/opencpi-setup.sh -e
    - make deploy Platforms=$HW_PLATFORM:$SW_PLATFORM
    - echo "IP- $IP"
    - echo "PORT- $PORT"
    - echo "HW- $HW_PLATFORM"
    - echo "SW- $SW_PLATFORM"
    - ocpiremote load -i $IP -r $PORT -w $HW_PLATFORM -s $SW_PLATFORM
    - ocpiremote start -i $IP
  after_script:
    - source ./cdk/opencpi-setup.sh -e
    - ocpiremote unload -i $IP
    - find -not -type d -newerct "$(< timestamp.txt)" > artifacts-$CI_JOB_ID.txt
    - tar -T artifacts-$CI_JOB_ID.txt -cf artifacts-$CI_JOB_ID.tar
    - ls -lh artifacts-$CI_JOB_ID.tar
    